{% extends "generic_template.html" %}

{% block content %}
    <form action="{{ action }}" method="post">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-9">
                {{ form.user.label_tag }}{{ form.user }}
                {{ form.establishment.label_tag }}{{ form.establishment }}
            </div>
            <div class="col-md-3">
            </div>
        </div>
        <div class="row" style="margin-bottom:20px;">
            <div class="col-md-9">
                {{ form.text }}
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary btn-block text-center">
                    <span class="glyphicon glyphicon-envelope" style="font-size:20px; margin-top:20px;" aria-hidden="true"></span>
                    <p style="font-size:20px; margin-bottom:10px;"><strong>Enviar</strong></p>
                </button>

            </div>
        </div>
    </form>

    {% for msg in msg_list %}
	<div class="row">
        {% if msg.origin == 1 %}
        <div class="col-md-9">
            <div class="well well-lg">
                {{ msg.text|linebreaksbr }}
                <div class="text-right">
                    <small>
                        {% if msg.user %}{{ msg.user.username }}{% endif %}
                        {% if msg.establishment %}{{ msg.establishment.name }}{% endif %}
                        {{ msg.eventDate }}
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3"></div>
        {% else %}
        <div class="col-md-3"></div>
        <div class="col-md-9">
            <div class="well well-lg" style="background: rgb(153, 204, 255);">
                {{ msg.text|linebreaksbr }}
                <div class="text-right">
                    <small>
                        {% if msg.user %}p/ {{ msg.user.username }}{% endif %}
                        {% if msg.establishment %}{{ msg.establishment.name }}{% endif %}
                        {{ msg.eventDate }}
                    </small>
                </div>
            </div>
        </div>
        {% endif %}
	</div>
    {% endfor %}

    <script>

        function replaceUrlParam(url, paramName, paramValue){
            var pattern = new RegExp('\\b('+paramName+'=).*?(&|$)')
            if(url.search(pattern)>=0){
                return url.replace(pattern,'$1' + paramValue + '$2');
            }
            return url + (url.indexOf('?')>0 ? '&' : '?') + paramName + '=' + paramValue
        }

        $('#id_user').change(function() {
            newloc = replaceUrlParam(window.location.href, 'user', this.value);
            window.location = newloc;
        });

        $('#id_establishment').change(function() {
            newloc = replaceUrlParam(window.location.href, 'estab', this.value);
            window.location = newloc;
        });

    </script>
{% endblock %}
